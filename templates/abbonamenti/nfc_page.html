{% extends "base.html" %}

{% block title %}{{ abbonamento.cliente.nome_completo }} - NFC Access{% endblock %}
{% block body_class %}nfc-access-page{% endblock %}

{% block content %}
<div class="nfc-access-container">
    
    <!-- Status Header -->
    <div class="status-header {% if not stato_ok %}status-error{% else %}status-success{% endif %} status-{{ stato_tipo }}">
        <div class="status-content">
            <div class="status-icon">
                {% if stato_ok %}
                    <span class="icon success">‚úÖ</span>
                    <h1>{{ stato_messaggio }}</h1>
                {% else %}
                    {% if stato_tipo == 'scaduto' %}
                        <span class="icon error">‚è∞</span>
                        <h1>{{ stato_messaggio }}</h1>
                    {% elif stato_tipo == 'esaurito' %}
                        <span class="icon error">üö´</span>
                        <h1>{{ stato_messaggio }}</h1>
                    {% elif stato_tipo == 'limite_giornaliero' %}
                        <span class="icon warning">‚è±Ô∏è</span>
                        <h1>{{ stato_messaggio }}</h1>
                    {% elif stato_tipo == 'non_pagato' %}
                        <span class="icon warning">üí≥</span>
                        <h1>{{ stato_messaggio }}</h1>
                    {% else %}
                        <span class="icon error">‚ùå</span>
                        <h1>Accesso Negato</h1>
                    {% endif %}
                {% endif %}
            </div>
            {% if motivo_blocco %}
            <div class="status-reason">
                <p>{{ motivo_blocco }}</p>
            </div>
            {% endif %}
            <div class="nfc-info">
                <span class="nfc-label">Codice NFC:</span>
                <span class="nfc-code">{{ abbonamento.codice_nfc }}</span>
            </div>
        </div>
    </div>
    
    <!-- Client Info Card -->
    <div class="info-card client-card">
        <div class="card-header">
            <h2>üë§ {{ abbonamento.cliente.nome_completo }}</h2>
            <div class="client-type">
                <span class="tipo-badge {% if abbonamento.cliente.is_business %}business{% else %}normale{% endif %}">
                    {{ abbonamento.cliente.tipo_cliente_display }}
                </span>
            </div>
            <div class="contact-info">
                <span class="phone">üìû {{ abbonamento.cliente.telefono | telefono }}</span>
                {% if abbonamento.cliente.email %}
                <span class="email">‚úâÔ∏è {{ abbonamento.cliente.email }}</span>
                {% endif %}
            </div>
        </div>
        
        <div class="vehicle-info">
            <div class="targa-display">{{ abbonamento.targa | targa }}</div>
            <div class="vehicle-details">
                <span class="type">{{ abbonamento.tipo_abbonamento | title }} {{ abbonamento.tipo_abbonamento | icona_tipo_abbonamento }}</span>
                <span class="price">{{ abbonamento.prezzo | currency }}</span>
            </div>
        </div>
    </div>
    
    <!-- Access Stats -->
    <div class="info-card stats-card">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number {% if abbonamento.accessi_rimanenti <= 2 %}danger{% elif abbonamento.accessi_rimanenti <= 5 %}warning{% else %}success{% endif %}">
                    {{ abbonamento.accessi_rimanenti }}
                </div>
                <div class="stat-label">Accessi Rimanenti</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-number {% if abbonamento.giorni_alla_scadenza <= 3 %}danger{% elif abbonamento.giorni_alla_scadenza <= 7 %}warning{% else %}success{% endif %}">
                    {{ abbonamento.giorni_alla_scadenza }}
                </div>
                <div class="stat-label">Giorni alla Scadenza</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-number">{{ abbonamento.accessi_utilizzati }}/{{ abbonamento.accessi_totali }}</div>
                <div class="stat-label">Accessi Utilizzati</div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="usage-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (abbonamento.accessi_utilizzati / abbonamento.accessi_totali * 100) }}%"></div>
            </div>
            <div class="progress-text">
                Utilizzo: {{ (abbonamento.accessi_utilizzati / abbonamento.accessi_totali * 100) | round(1) }}%
            </div>
        </div>
    </div>
    
    <!-- Warning Messages -->
    {% if messaggi %}
    <div class="messages-card">
        {% for messaggio in messaggi %}
        <div class="alert alert-warning">
            <span class="alert-text">{{ messaggio }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Main Actions -->
    <div class="actions-card">
        {% if stato_ok %}
        <!-- Register Access -->
        <div class="primary-action">
            <button id="registerAccessBtn" class="btn-register" onclick="registraAccesso()">
                <div class="btn-content">
                    <div class="btn-icon">üöø</div>
                    <div class="btn-text">
                        <span class="btn-title">Registra Accesso</span>
                        <span class="btn-subtitle">Lavaggio autolavaggio</span>
                    </div>
                </div>
            </button>
        </div>
        {% endif %}
        
        <!-- Secondary Actions -->
        <div class="secondary-actions">
            <div class="action-grid">
                <a href="{{ url_for('abbonamenti.dettaglio', id=abbonamento.id) }}" class="action-btn">
                    <span class="action-icon">üëÅÔ∏è</span>
                    <span class="action-text">Dettagli Completi</span>
                </a>
                
                <a href="{{ url_for('abbonamenti.modifica', id=abbonamento.id) }}" class="action-btn">
                    <span class="action-icon">‚úèÔ∏è</span>
                    <span class="action-text">Modifica</span>
                </a>
                
                {% if not abbonamento.is_scaduto %}
                <button onclick="rinnovaAbbonamento()" class="action-btn">
                    <span class="action-icon">üîÑ</span>
                    <span class="action-text">Rinnova</span>
                </button>
                {% endif %}
                
                <a href="{{ url_for('stampa.ricevuta', abbonamento_id=abbonamento.id) }}" class="action-btn">
                    <span class="action-icon">üñ®Ô∏è</span>
                    <span class="action-text">Stampa</span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Recent Access Timeline -->
    {% if accessi_recenti %}
    <div class="info-card timeline-card">
        <div class="card-header">
            <h3>üïê Accessi Recenti</h3>
        </div>
        <div class="timeline">
            {% for accesso in accessi_recenti | reverse %}
            <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-date">{{ accesso.data_ora | datetime }}</div>
                    <div class="timeline-operator">Operatore: {{ accesso.operatore.nome }}</div>
                    {% if accesso.note %}
                    <div class="timeline-note">{{ accesso.note }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Subscription Details -->
    <div class="info-card details-card">
        <div class="details-grid">
            <div class="detail-item">
                <span class="detail-label">Periodo:</span>
                <span class="detail-value">{{ abbonamento.data_inizio | date }} - {{ abbonamento.data_fine | date }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Stato Pagamento:</span>
                <span class="detail-value {{ 'paid' if abbonamento.stato_pagamento == 'pagato' else 'unpaid' }}">
                    {{ abbonamento.stato_pagamento.replace('_', ' ').title() }}
                    {% if abbonamento.stato_pagamento == 'pagato' %}‚úÖ{% else %}‚è≥{% endif %}
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Cliente dal:</span>
                <span class="detail-value">{{ abbonamento.cliente.data_registrazione | date }}</span>
            </div>
        </div>
    </div>
    
    <!-- Share/Link Actions -->
    <div class="share-card">
        <div class="share-info">
            <span class="share-label">URL di questo abbonamento:</span>
            <div class="share-url" id="shareUrl">{{ request.url }}</div>
        </div>
        <button onclick="copyUrl()" class="btn btn-secondary btn-sm">
            üìã Copia Link
        </button>
    </div>
</div>

<style>
.nfc-access-page {
    background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
    min-height: 100vh;
}

.nfc-access-container {
    max-width: 500px;
    margin: 0 auto;
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.status-header {
    text-align: center;
    padding: var(--spacing-xl);
    border-radius: var(--border-radius-xl);
    color: var(--white);
    margin-bottom: var(--spacing-md);
    box-shadow: var(--shadow-lg);
}

.status-header.status-success {
    background: linear-gradient(135deg, var(--success-color), var(--success-dark));
}

.status-header.status-error {
    background: linear-gradient(135deg, var(--danger-color), var(--danger-dark));
}

.status-header.status-scaduto {
    background: linear-gradient(135deg, #9333ea, #7c3aed);
}

.status-header.status-esaurito {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.status-header.status-limite_giornaliero {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.status-header.status-non_pagato {
    background: linear-gradient(135deg, #0891b2, #0e7490);
}

.status-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.status-icon .icon {
    font-size: 3rem;
    display: block;
    margin-bottom: var(--spacing-sm);
}

.status-header h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
}

.status-reason {
    margin-top: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius);
    border-left: 4px solid rgba(255, 255, 255, 0.5);
}

.status-reason p {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 500;
    opacity: 0.95;
}

.nfc-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    font-family: monospace;
}

.nfc-label {
    opacity: 0.9;
    font-size: 0.875rem;
}

.nfc-code {
    background: rgba(255, 255, 255, 0.2);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius);
    font-weight: 700;
    letter-spacing: 0.1em;
}

.info-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    overflow: hidden;
}

.client-card .card-header {
    padding: var(--spacing-lg);
    background: var(--primary-color);
    color: var(--white);
}

.client-card h2 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 1.25rem;
}

.client-type {
    margin: var(--spacing-sm) 0;
}

.tipo-badge {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius);
    font-size: 0.75rem;
    font-weight: 600;
}

.tipo-badge.business {
    background: var(--primary-color);
    color: var(--white);
}

.tipo-badge.normale {
    background: var(--gray-400);
    color: var(--white);
}

.contact-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    opacity: 0.9;
}

.vehicle-info {
    padding: var(--spacing-lg);
    text-align: center;
}

.targa-display {
    font-family: monospace;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: var(--spacing-md);
    letter-spacing: 0.1em;
}

.vehicle-details {
    display: flex;
    justify-content: center;
    gap: var(--spacing-lg);
    color: var(--gray-600);
}

.stats-card {
    padding: var(--spacing-lg);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: var(--spacing-xs);
}

.stat-number.success { color: var(--success-color); }
.stat-number.warning { color: var(--warning-color); }
.stat-number.danger { color: var(--danger-color); }

.stat-label {
    font-size: 0.875rem;
    color: var(--gray-600);
    font-weight: 500;
}

.usage-progress {
    background: var(--gray-50);
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: var(--gray-200);
    border-radius: var(--border-radius);
    overflow: hidden;
    margin-bottom: var(--spacing-sm);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color), var(--primary-color));
    transition: width 0.5s ease;
}

.progress-text {
    text-align: center;
    font-size: 0.875rem;
    color: var(--gray-600);
    font-weight: 500;
}

.messages-card {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.alert {
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    color: var(--warning-dark);
}

.actions-card {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.primary-action {
    text-align: center;
}

.btn-register {
    width: 100%;
    padding: var(--spacing-lg);
    background: linear-gradient(135deg, var(--success-color), var(--success-dark));
    color: var(--white);
    border: none;
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    transition: all var(--transition-fast);
    cursor: pointer;
}

.btn-register:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.btn-register:active {
    transform: translateY(0);
}

.btn-content {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.btn-icon {
    font-size: 2rem;
}

.btn-text {
    display: flex;
    flex-direction: column;
    text-align: left;
}

.btn-title {
    font-size: 1.25rem;
    font-weight: 700;
}

.btn-subtitle {
    font-size: 0.875rem;
    opacity: 0.9;
}

.secondary-actions {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
}

.action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-md);
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
    text-decoration: none;
    color: var(--gray-700);
    transition: all var(--transition-fast);
    cursor: pointer;
}

.action-btn:hover {
    background: var(--gray-100);
    transform: translateY(-1px);
}

.action-icon {
    font-size: 1.5rem;
}

.action-text {
    font-size: 0.875rem;
    font-weight: 500;
}

.timeline-card {
    padding: var(--spacing-lg);
}

.timeline-card .card-header {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--gray-200);
}

.timeline-card h3 {
    margin: 0;
    color: var(--gray-700);
}

.timeline {
    position: relative;
    padding-left: var(--spacing-lg);
}

.timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--gray-200);
}

.timeline-item {
    position: relative;
    margin-bottom: var(--spacing-md);
}

.timeline-dot {
    position: absolute;
    left: -var(--spacing-lg);
    top: 4px;
    width: 12px;
    height: 12px;
    background: var(--primary-color);
    border-radius: 50%;
    border: 2px solid var(--white);
    box-shadow: 0 0 0 2px var(--gray-200);
}

.timeline-content {
    background: var(--gray-50);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius);
}

.timeline-date {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 0.875rem;
}

.timeline-operator {
    color: var(--gray-600);
    font-size: 0.875rem;
}

.timeline-note {
    font-style: italic;
    color: var(--gray-500);
    font-size: 0.875rem;
    margin-top: var(--spacing-xs);
}

.details-card {
    padding: var(--spacing-lg);
}

.details-grid {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--gray-100);
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 500;
    color: var(--gray-600);
}

.detail-value {
    font-weight: 600;
    color: var(--gray-900);
    text-align: right;
}

.detail-value.paid {
    color: var(--success-color);
}

.detail-value.unpaid {
    color: var(--warning-color);
}

.share-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.share-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.share-label {
    font-size: 0.875rem;
    color: var(--gray-600);
    font-weight: 500;
}

.share-url {
    font-family: monospace;
    font-size: 0.75rem;
    background: var(--gray-50);
    padding: var(--spacing-sm);
    border-radius: var(--border-radius);
    word-break: break-all;
    color: var(--gray-700);
}

/* Mobile Optimizations */
@media (max-width: 767px) {
    .nfc-access-container {
        padding: var(--spacing-sm);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
    
    .btn-content {
        justify-content: center;
        text-align: center;
    }
    
    .btn-text {
        text-align: center;
    }
    
    .vehicle-details {
        flex-direction: column;
        gap: var(--spacing-sm);
    }
    
    .targa-display {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Anima progress bar
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        const width = progressFill.style.width;
        progressFill.style.width = '0%';
        setTimeout(() => {
            progressFill.style.width = width;
        }, 500);
    }
});

// Registra accesso
function registraAccesso() {
    const btn = document.getElementById('registerAccessBtn');
    const originalContent = btn.innerHTML;
    
    // Disabilita pulsante
    btn.disabled = true;
    btn.innerHTML = '<div class="btn-content"><div class="btn-icon">‚è≥</div><div class="btn-text"><span class="btn-title">Registrazione...</span><span class="btn-subtitle">Attendere prego</span></div></div>';
    
    // Vibrazione feedback
    if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
    }
    
    fetch('/accessi/api/registra-accesso', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            abbonamento_id: {{ abbonamento.id }},
            note: 'Accesso tramite NFC'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success feedback
            btn.innerHTML = '<div class="btn-content"><div class="btn-icon">‚úÖ</div><div class="btn-text"><span class="btn-title">Registrato!</span><span class="btn-subtitle">Accesso consentito</span></div></div>';
            btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            
            // Vibrazione successo
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            // Ricarica pagina dopo 2 secondi
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            // Error feedback
            btn.innerHTML = '<div class="btn-content"><div class="btn-icon">‚ùå</div><div class="btn-text"><span class="btn-title">Errore</span><span class="btn-subtitle">' + data.message + '</span></div></div>';
            btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            
            // Ripristina pulsante dopo 3 secondi
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                btn.style.background = '';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        btn.innerHTML = '<div class="btn-content"><div class="btn-icon">‚ùå</div><div class="btn-text"><span class="btn-title">Errore</span><span class="btn-subtitle">Connessione fallita</span></div></div>';
        btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            btn.style.background = '';
        }, 3000);
    });
}

// Rinnova abbonamento
function rinnovaAbbonamento() {
    if (confirm('Rinnovare l\'abbonamento?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("abbonamenti.rinnova", id=abbonamento.id) }}';
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        form.appendChild(csrf);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Copia URL
function copyUrl() {
    const url = document.getElementById('shareUrl').textContent;
    navigator.clipboard.writeText(url).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copiato!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    });
}
</script>
{% endblock %}